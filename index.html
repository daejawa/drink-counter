<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ìˆ ì” ì¹´ìš´í„°</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="ìˆ ì” ì¹´ìš´í„°">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  *{ box-sizing:border-box; }
  :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif; }
  body { margin: 0; background:#0f1115; color:#eaeaea; }

  header {
    position: sticky; top: 0; background:#0f1115;
    padding: calc(12px + env(safe-area-inset-top)) 16px 12px;
    border-bottom:1px solid #222; z-index:3;
    display:flex; align-items:center; gap:8px; justify-content:space-between;
  }
  h1 { font-size:18px; margin:0; }
  .tabs { display:flex; gap:6px; }
  .tab { padding:6px 10px; border-radius:999px; border:1px solid #2a2e3f; background:#141722; cursor:pointer; }
  .tab.active { background:#2a6ef0; border-color:#2a6ef0; color:white; }

  .row { display:flex; gap:8px; margin:8px 16px; }
  .row.stack { flex-direction:column; }
  .row .full { width:100%; }

  input[type="number"], input[type="text"] {
    flex:1; padding:12px; border-radius:10px; border:1px solid #333; background:#141722; color:#eaeaea;
  }
  button { padding:10px 14px; border:1px solid #333; background:#1a1f2e; color:#eaeaea; border-radius:10px; }
  button.primary { background:#2a6ef0; border-color:#2a6ef0; color:white; }
  button.warn { background:#3a1b1b; border-color:#5a2b2b; color:#ffb0b0; }

  .list { margin:8px 8px calc(140px + env(safe-area-inset-bottom)); }

  /* ì¹´ë“œ ë ˆì´ì•„ì›ƒ: ì•„ë°”íƒ€ | ì´ë¦„ | ì£¼ì¢… ë²„íŠ¼ 3ê°œ | í•©ê³„ */
  .card {
    display:grid;
    grid-template-columns: auto 1fr 40px 40px 40px 70px;
    align-items:center;
    gap:8px; padding:12px; margin:8px;
    background:#141722; border:1px solid #2a2e3f; border-radius:12px;
  }
  .nameSeat { min-width:0; }
  .name { font-weight:600; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  .seat { font-size:12px; opacity:.7; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  .pill { width:36px; padding:6px 0; border-radius:8px; border:1px solid #2a2e3f; background:#1a1f2e; text-align:center; }
  .pill.small { width:40px; padding:6px 0; }
  .shots { width:70px; text-align:right; font-variant-numeric: tabular-nums; }

  .footer {
    position: fixed; left:0; right:0; bottom:0; background:#0f1115; border-top:1px solid #222;
    padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
    z-index:2;
  }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  small.hint { display:block; text-align:center; opacity:.7; margin:4px 0 8px; }

  /* ì›í˜• ì¢Œì„ ë°°ì¹˜ */
  .circle-wrap { position:relative; height: 360px; margin: 16px; }
  .table-circle {
    position:absolute; inset:0; margin:auto; width: 320px; height:320px;
    border-radius:50%; border:2px dashed #2a2e3f; opacity:.7;
  }
  .seat-dot {
    position:absolute; width:80px; height:56px; transform:translate(-50%,-50%);
    display:flex; align-items:center; justify-content:center; text-align:center;
    padding:6px; border-radius:12px; background:#141722; border:1px solid #2a2e3f; cursor:pointer;
  }
  .seat-dot.active { outline:2px solid #2a6ef0; }
  .seat-dot .label { font-size:12px; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:72px; }
  .seat-legend { text-align:center; opacity:.75; font-size:12px; margin-top:6px; }
</style>
</head>
<body>
<header>
  <h1>ìˆ ì” ì¹´ìš´í„°</h1>
  <div class="tabs">
    <div class="tab active" id="tab-list">ë¦¬ìŠ¤íŠ¸</div>
    <div class="tab" id="tab-circle">ì›í˜• ì¢Œì„</div>
    <div class="tab" id="tab-weights">ê°€ì¤‘ì¹˜</div>
  </div>
</header>

<section class="row">
  <input id="food" type="number" inputmode="numeric" placeholder="ğŸ² ìŒì‹ ì´ì•¡(ì›)">
  <input id="alcohol" type="number" inputmode="numeric" placeholder="ğŸ¶ ìˆ  ì´ì•¡(ì›)">
</section>

<section class="row stack">
  <div style="display:flex; gap:8px;">
    <input id="newName" type="text" placeholder="ì´ë¦„(ë¹ˆì¹¸ì´ë©´ â€˜ì†ë‹˜ Nâ€™)">
    <input id="newSeat" type="text" placeholder="ì¢Œì„ë²ˆí˜¸(ì„ íƒ: 1,2,3â€¦)">
  </div>
  <button id="add" class="primary full">+ ì¶”ê°€</button>
</section>

<small class="hint">ì£¼ì¢… ë²„íŠ¼(ì†Œ/ë§¥/ì™€): íƒ­ = +1, ê¸¸ê²Œ = âˆ’1 â€¢ ì¢Œì„ë²ˆí˜¸ë¡œ ì›í˜• ë°°ì¹˜ ì •ë ¬</small>

<!-- ë·°: ë¦¬ìŠ¤íŠ¸ -->
<div id="view-list">
  <div id="list" class="list"></div>
</div>

<!-- ë·°: ì›í˜• ì¢Œì„ -->
<div id="view-circle" style="display:none;">
  <div class="circle-wrap">
    <div class="table-circle"></div>
    <div id="circle-seats"></div>
  </div>
  <div class="seat-legend">ì‚¬ëŒì„ íƒ­í•˜ë©´ ì„ íƒë¨ â†’ ì•„ë˜ â€˜ì •ì‚° ë³´ê¸°â€™ë¡œ ê³„ì‚°</div>
</div>

<!-- ë·°: ê°€ì¤‘ì¹˜ ì„¤ì • -->
<div id="view-weights" style="display:none; margin:8px 16px 120px;">
  <div class="row">
    <label style="flex:1;">ì†Œì£¼ ê°€ì¤‘ì¹˜<input id="w-soju" type="number" step="0.1" inputmode="decimal" placeholder="ì˜ˆ: 1.0"></label>
    <label style="flex:1;">ë§¥ì£¼ ê°€ì¤‘ì¹˜<input id="w-beer" type="number" step="0.1" inputmode="decimal" placeholder="ì˜ˆ: 1.0"></label>
  </div>
  <div class="row">
    <label style="flex:1;">ì™€ì¸ ê°€ì¤‘ì¹˜<input id="w-wine" type="number" step="0.1" inputmode="decimal" placeholder="ì˜ˆ: 1.5"></label>
    <button id="save-weights" class="primary">ê°€ì¤‘ì¹˜ ì €ì¥</button>
  </div>
  <small class="hint">ê°€ì¤‘ì¹˜ëŠ” ìˆ ê°’ ë¶„ë°°ì—ë§Œ ì ìš©ë©ë‹ˆë‹¤. (ìŒì‹ê°’ì€ ì¸ì› ê· ë“±)</small>
</div>

<div class="footer">
  <div class="grid" style="margin-bottom:8px">
    <button id="settle" class="primary">ì •ì‚° ë³´ê¸°</button>
    <button id="reset" class="warn">ë¦¬ì…‹</button>
  </div>
  <div class="grid">
    <button id="exportBtn" class="primary">ì •ì‚°í‘œ ë‚´ë³´ë‚´ê¸°</button>
    <button id="importBtn">ê°€ì ¸ì˜¤ê¸°</button>
  </div>
</div>

<script>
  // ---- ìƒíƒœ ----
  const state = {
    people: [],
    foodTotal: 0,
    alcoholTotal: 0,
    counter: 0,
    weights: { soju: 1.0, beer: 1.0, wine: 1.5 },  // ê¸°ë³¸ ê°€ì¤‘ì¹˜
    selectedId: null, // ì›í˜• ì¢Œì„ì—ì„œ ì„ íƒëœ ì‚¬ëŒ
  };

  // ---- ì €ì¥/ë³µì› ----
  const save = () => localStorage.setItem('drinkCounterStateV2', JSON.stringify(state));
  const load = () => {
    // v2 ìš°ì„  ë¡œë“œ
    const rawV2 = localStorage.getItem('drinkCounterStateV2');
    if (rawV2) {
      try { Object.assign(state, JSON.parse(rawV2)); } catch {}
      return;
    }
    // v1 ë§ˆì´ê·¸ë ˆì´ì…˜
    const rawV1 = localStorage.getItem('drinkCounterState');
    if (rawV1) {
      try {
        const v1 = JSON.parse(rawV1);
        state.people = (v1.people||[]).map(p=>({
          id: p.id || crypto.randomUUID(),
          name: p.name, seat: p.seat || '',
          drinks: { soju: p.shots||0, beer: 0, wine: 0 } // shotsë¥¼ ì†Œì£¼ë¡œ ì´ê´€
        }));
        state.foodTotal = v1.foodTotal||0;
        state.alcoholTotal = v1.alcoholTotal||0;
        state.counter = v1.counter||state.people.length;
      } catch {}
    }
  };

  // ---- ìœ í‹¸ ----
  const money = n => new Intl.NumberFormat('ko-KR').format(Math.round(n || 0));
  const promptEdit = (label, value) => {
    const v = window.prompt(label, value ?? '');
    return v === null ? null : v.trim();
  };
  const personTotalCount = p => (p.drinks.soju||0) + (p.drinks.beer||0) + (p.drinks.wine||0);
  const personWeighted = p =>
    (p.drinks.soju||0)*state.weights.soju +
    (p.drinks.beer||0)*state.weights.beer +
    (p.drinks.wine||0)*state.weights.wine;

  // ---- íƒ­ ì „í™˜ ----
  const views = {
    list: document.getElementById('view-list'),
    circle: document.getElementById('view-circle'),
    weights: document.getElementById('view-weights')
  };
  function switchTab(name){
    document.getElementById('tab-list').classList.toggle('active', name==='list');
    document.getElementById('tab-circle').classList.toggle('active', name==='circle');
    document.getElementById('tab-weights').classList.toggle('active', name==='weights');
    views.list.style.display = name==='list' ? '' : 'none';
    views.circle.style.display = name==='circle' ? '' : 'none';
    views.weights.style.display = name==='weights' ? '' : 'none';
    if (name==='circle') renderCircle();
    if (name==='weights') renderWeights();
  }
  document.getElementById('tab-list').onclick = ()=>switchTab('list');
  document.getElementById('tab-circle').onclick = ()=>switchTab('circle');
  document.getElementById('tab-weights').onclick = ()=>switchTab('weights');

  // ---- ë Œë”(ë¦¬ìŠ¤íŠ¸) ----
  const listEl = document.getElementById('list');
  function renderList() {
    document.getElementById('food').value = state.foodTotal || '';
    document.getElementById('alcohol').value = state.alcoholTotal || '';
    listEl.innerHTML = '';
    state.people.forEach((p, idx) => {
      if (!p.drinks) p.drinks = { soju:0, beer:0, wine:0 };

      const card = document.createElement('div'); card.className = 'card';

      const avatar = document.createElement('div');
      avatar.className = 'pill'; avatar.textContent = p.name.slice(0,2);
      avatar.style.cursor = 'pointer'; avatar.title = 'ì‚­ì œ';
      avatar.onclick = () => {
        if (confirm(`ì‚­ì œí• ê¹Œìš”? ${p.name}`)) { state.people.splice(idx,1); save(); render(); }
      };

      const nameSeat = document.createElement('div'); nameSeat.className = 'nameSeat';
      const name = document.createElement('div'); name.className = 'name'; name.textContent = p.name; name.style.cursor='pointer';
      name.onclick = () => {
        const v = promptEdit('ì´ë¦„ ìˆ˜ì •', p.name); if (v !== null) { p.name = v || p.name; save(); render(); }
      };
      const seat = document.createElement('div'); seat.className = 'seat';
      seat.textContent = p.seat ? `ì¢Œì„: ${p.seat}` : 'ì¢Œì„ ë¯¸ì§€ì •'; seat.style.cursor='pointer';
      seat.onclick = () => {
        const v = promptEdit('ì¢Œì„ë²ˆí˜¸(ì˜ˆ: 1,2,3â€¦)', p.seat || '');
        if (v !== null) { p.seat = v || ''; save(); render(); }
      };
      nameSeat.appendChild(name); nameSeat.appendChild(seat);

      // ì£¼ì¢… ë²„íŠ¼(ì†Œ/ë§¥/ì™€)
      const makeDrinkBtn = (label, key) => {
        const b = document.createElement('button');
        b.className = 'pill small';
        b.textContent = label; // ì†Œ/ë§¥/ì™€
        let timer=null, longPress=false, startY=0;
        const add = () => { p.drinks[key] = (p.drinks[key]||0) + 1; save(); render(); };
        const sub = () => { p.drinks[key] = Math.max(0, (p.drinks[key]||0) - 1); save(); render(); };
        b.addEventListener('click', add);
        b.addEventListener('touchstart', e => {
          longPress=false; startY = e.touches[0].clientY;
          timer = setTimeout(()=>{ longPress=true; sub(); timer=null; }, 500);
        }, {passive:true});
        b.addEventListener('touchmove', e => {
          if (timer && Math.abs(e.touches[0].clientY-startY)>8){ clearTimeout(timer); timer=null; }
        }, {passive:true});
        b.addEventListener('touchend', () => { if (timer){ clearTimeout(timer); timer=null; if(!longPress) add(); }});
        return b;
      };
      const sojuBtn = makeDrinkBtn('ì†Œ', 'soju');
      const beerBtn = makeDrinkBtn('ë§¥', 'beer');
      const wineBtn = makeDrinkBtn('ì™€', 'wine');

      const shots = document.createElement('div'); shots.className = 'shots';
      shots.innerHTML = `${personTotalCount(p)}ì”<br><span style="opacity:.7;font-size:12px;">w:${personWeighted(p).toFixed(1)}</span>`;

      card.appendChild(avatar);
      card.appendChild(nameSeat);
      card.appendChild(sojuBtn);
      card.appendChild(beerBtn);
      card.appendChild(wineBtn);
      card.appendChild(shots);
      listEl.appendChild(card);
    });
  }

  // ---- ë Œë”(ì›í˜• ì¢Œì„) ----
  function renderCircle(){
    const wrap = document.getElementById('circle-seats');
    wrap.innerHTML = '';
    // ì¢Œì„ë²ˆí˜¸ê°€ ìˆëŠ” ì‚¬ëŒ ë¨¼ì € ì •ë ¬(ìˆ«ì ì˜¤ë¦„ì°¨ìˆœ), ì—†ìœ¼ë©´ ë’¤ì—
    const withSeat = state.people.filter(p=>p.seat && String(p.seat).trim()!=='').sort((a,b)=>Number(a.seat)-Number(b.seat));
    const withoutSeat = state.people.filter(p=>!p.seat || String(p.seat).trim()==='');
    const arr = [...withSeat, ...withoutSeat];
    const N = Math.max(arr.length, 1);
    const cx = 160, cy = 160, R = 140; // ì¤‘ì‹¬, ë°˜ì§€ë¦„
    arr.forEach((p, i) => {
      const angle = (2*Math.PI*i)/N - Math.PI/2; // ìœ„ìª½ë¶€í„° ì‹œê³„ë°©í–¥
      const x = cx + R * Math.cos(angle);
      const y = cy + R * Math.sin(angle);
      const dot = document.createElement('div'); dot.className='seat-dot';
      dot.style.left = x+'px'; dot.style.top = y+'px';
      if (state.selectedId === p.id) dot.classList.add('active');
      dot.onclick = () => { state.selectedId = (state.selectedId===p.id ? null : p.id); renderCircle(); };
      const label = document.createElement('div'); label.className='label';
      const seatTxt = p.seat ? `[${p.seat}] ` : '';
      label.textContent = `${seatTxt}${p.name} (${personTotalCount(p)}|${personWeighted(p).toFixed(1)})`;
      dot.appendChild(label);
      wrap.appendChild(dot);
    });
  }

  // ---- ë Œë”(ê°€ì¤‘ì¹˜) ----
  function renderWeights(){
    document.getElementById('w-soju').value = state.weights.soju;
    document.getElementById('w-beer').value = state.weights.beer;
    document.getElementById('w-wine').value = state.weights.wine;
  }
  document.getElementById('save-weights').onclick = () => {
    const s = parseFloat(document.getElementById('w-soju').value)||0;
    const b = parseFloat(document.getElementById('w-beer').value)||0;
    const w = parseFloat(document.getElementById('w-wine').value)||0;
    if (s<=0 || b<=0 || w<=0) { alert('ê°€ì¤‘ì¹˜ëŠ” ëª¨ë‘ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.'); return; }
    state.weights = { soju:s, beer:b, wine:w }; save(); render();
    alert('ê°€ì¤‘ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  };

  function render(){ renderList(); if (document.getElementById('tab-circle').classList.contains('active')) renderCircle(); }

  // ---- ì •ì‚° ----
  function buildSettlementText() {
    const n = state.people.length || 1;
    const foodPer = (Number(state.foodTotal)||0) / n;

    const totalWeighted = state.people.reduce((acc,p)=>acc+personWeighted(p),0);
    let lines = [];
    lines.push(`ğŸ² ìŒì‹ ê· ë“±: â‚©${money(state.foodTotal)} / ğŸ¶ ìˆ  ì”ìˆ˜ë¹„ë¡€: â‚©${money(state.alcoholTotal)}`);
    lines.push(`ê°€ì¤‘ì¹˜: ì†Œì£¼ ${state.weights.soju}, ë§¥ì£¼ ${state.weights.beer}, ì™€ì¸ ${state.weights.wine}`);
    lines.push('â€” â€” â€”');
    state.people.forEach(p => {
      const alcShare = totalWeighted>0 ? (personWeighted(p)/totalWeighted) * (Number(state.alcoholTotal)||0) : 0;
      const pay = foodPer + alcShare;
      const parts = [];
      if (p.drinks.soju) parts.push(`ì†Œ${p.drinks.soju}`);
      if (p.drinks.beer) parts.push(`ë§¥${p.drinks.beer}`);
      if (p.drinks.wine) parts.push(`ì™€${p.drinks.wine}`);
      const mix = parts.join('/');
      lines.push(`${p.name}${p.seat?`(${p.seat})`:''} â†’ â‚©${money(pay)}  [${mix||'0'} | w:${personWeighted(p).toFixed(1)}]`);
    });
    return lines.join('\n');
  }
  function settle() {
    const text = buildSettlementText();
    if (navigator.share) { navigator.share({ text, title: 'ì •ì‚° ê²°ê³¼' }).catch(()=>alert(text)); }
    else { alert(text); }
  }

  // ---- ì´ë²¤íŠ¸ ë°”ì¸ë”© ----
  document.getElementById('add').onclick = () => {
    const name = (document.getElementById('newName').value || '').trim();
    const seat = (document.getElementById('newSeat').value || '').trim();
    state.counter = (state.counter||0) + 1;
    state.people.push({ id: crypto.randomUUID(), name: name || `ì†ë‹˜ ${state.counter}`, seat: seat || '', drinks:{soju:0,beer:0,wine:0} });
    document.getElementById('newName').value=''; document.getElementById('newSeat').value='';
    save(); render();
  };
  document.getElementById('food').addEventListener('input', e => { state.foodTotal = Number(e.target.value||0); save(); });
  document.getElementById('alcohol').addEventListener('input', e => { state.alcoholTotal = Number(e.target.value||0); save(); });
  document.getElementById('settle').onclick = settle;

  document.getElementById('reset').onclick = () => {
    if (!confirm('ëª¨ë“  ì”ìˆ˜ì™€ ê¸ˆì•¡ì„ 0ìœ¼ë¡œ ë¦¬ì…‹í• ê¹Œìš”?')) return;
    state.people.forEach(p => p.drinks={soju:0,beer:0,wine:0});
    state.foodTotal = 0; state.alcoholTotal = 0; save(); render();
  };

  // ê°€ì ¸ì˜¤ê¸°
  document.getElementById('importBtn').onclick = async () => {
    const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json';
    inp.onchange = async (e) => {
      const file = e.target.files[0]; if (!file) return;
      try { const data = JSON.parse(await file.text()); Object.assign(state, data); if(!state.weights) state.weights={soju:1,beer:1,wine:1.5}; save(); render(); }
      catch { alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON í˜•ì‹ ì˜¤ë¥˜'); }
    };
    inp.click();
  };

  // ì •ì‚°í‘œ ë‚´ë³´ë‚´ê¸°(íƒ­=í…ìŠ¤íŠ¸ ê³µìœ , ê¸¸ê²Œ=JSON ë°±ì—…)
  (() => {
    const btn = document.getElementById('exportBtn');
    let timer=null, longPressed=false;
    btn.addEventListener('touchstart', () => {
      longPressed=false; timer=setTimeout(()=>{ longPressed=true; downloadJsonBackup(); }, 600);
    }, {passive:true});
    btn.addEventListener('touchend', () => {
      if (timer) clearTimeout(timer);
      if (!longPressed) {
        const text = buildSettlementText();
        if (navigator.share) navigator.share({title:'ì •ì‚°í‘œ', text}).catch(()=>alert(text));
        else alert(text);
      }
    });
    btn.addEventListener('contextmenu', e => { e.preventDefault(); downloadJsonBackup(); });
    btn.addEventListener('click', () => {
      const text = buildSettlementText();
      if (navigator.share) navigator.share({title:'ì •ì‚°í‘œ', text}).catch(()=>alert(text));
      else alert(text);
    });
  })();
  function downloadJsonBackup() {
    const payload = JSON.stringify(state, null, 2);
    const blob = new Blob([payload], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'drink-counter.json'});
    a.click(); URL.revokeObjectURL(url);
  }

  // ---- PWA ë“±ë¡ ----
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js?v=20250817').catch(()=>{});
    });
  }

  // ì´ˆê¸°í™”
  load(); render();
</script>
</body>
</html>
