<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ìˆ ì” ì¹´ìš´í„° V1.1</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="ìˆ ì” ì¹´ìš´í„°">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif; }
  body { margin: 0; background:#0f1115; color:#eaeaea; }
  header {
  position: sticky; top: 0; background:#0f1115;
  padding: calc(12px + env(safe-area-inset-top)) 16px 12px; 
  border-bottom:1px solid #222; z-index:2;
}
h1 { font-size:18px; margin:0; }
.row { display:flex; gap:8px; margin:8px 16px; }
input[type="number"], input[type="text"] {
  flex:1; padding:12px; border-radius:10px; border:1px solid #333; background:#141722; color:#eaeaea;
}
button { padding:10px 14px; border:1px solid #333; background:#1a1f2e; color:#eaeaea; border-radius:10px;}
button.primary { background:#2a6ef0; border-color:#2a6ef0; color:white; }
button.warn { background:#3a1b1b; border-color:#5a2b2b; color:#ffb0b0; }
.list { margin:8px 8px 120px; }
.card {
  display: grid;
  grid-template-columns: auto 1fr auto auto auto; /* ì•„ë°”íƒ€ | ì´ë¦„+ì¢Œì„ | âˆ’ | ìˆ«ì | + */
  align-items: center;
  gap: 8px;
  padding: 12px;
  margin: 8px;
  background:#141722;
  border:1px solid #2a2e3f;
  border-radius:12px;
}

.shots {
  min-width: 50px; /* í•„ìš”ì— ë§ê²Œ ì¡°ì • */
  text-align: center;
  font-variant-numeric: tabular-nums;
}
.nameSeat { flex:1; }
.name { font-weight:600; }
.seat { font-size:12px; opacity:.7; }
.pill {
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid #2a2e3f;
  background: #1a1f2e;
  }
  .footer {
  position: fixed; left:0; right:0; bottom:0; background:#0f1115; border-top:1px solid #222;
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
}
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  small.hint { display:block; text-align:center; opacity:.7; margin:4px 0 8px; }
</style>
</head>
<body>
<header>
  <h1>ìˆ ì” ì¹´ìš´í„°</h1>
</header>

<section class="row">
  <input id="food" type="number" inputmode="numeric" placeholder="ğŸ² ìŒì‹ ì´ì•¡(ì›)">
  <input id="alcohol" type="number" inputmode="numeric" placeholder="ğŸ¶ ìˆ  ì´ì•¡(ì›)">
</section>

<section class="row">
  <input id="newName" type="text" placeholder="ì´ë¦„(ë¹ˆì¹¸ì´ë©´ â€˜ì†ë‹˜ Nâ€™)">
  <input id="newSeat" type="text" placeholder="ì¢Œì„(ì„ íƒ)">
  <button id="add" class="primary">+ ì¶”ê°€</button>
</section>

<small class="hint">ì´ë¦„/ì¢Œì„ì„ íƒ­í•˜ë©´ í¸ì§‘ â€¢ ì”ìˆ˜ëŠ” íƒ­=+1, ê¸¸ê²Œ=âˆ’1</small>

<div id="list" class="list"></div>

<div class="footer">
  <div class="grid" style="margin-bottom:8px">
    <button id="settle" class="primary">ì •ì‚° ë³´ê¸°</button>
    <button id="reset" class="warn">ë¦¬ì…‹</button>
  </div>
  <div class="grid">
    <button id="exportBtn">ë‚´ë³´ë‚´ê¸°</button>
    <button id="importBtn">ê°€ì ¸ì˜¤ê¸°</button>
  </div>
</div>

<script>
  // ---- ìƒíƒœ ----
  const state = {
    people: [],
    foodTotal: 0,
    alcoholTotal: 0,
    counter: 0, // ì†ë‹˜ ë²ˆí˜¸ ì¦ê°€ìš©
  };

  // ---- ì €ì¥/ë³µì› ----
  const save = () => {
    localStorage.setItem('drinkCounterState', JSON.stringify(state));
  };
  const load = () => {
    const raw = localStorage.getItem('drinkCounterState');
    if (raw) {
      try {
        const s = JSON.parse(raw);
        Object.assign(state, s);
      } catch {}
    }
  };

  // ---- ìœ í‹¸ ----
  const money = n => new Intl.NumberFormat('ko-KR').format(Math.round(n || 0));
  const promptEdit = (label, value) => {
    const v = window.prompt(label, value ?? '');
    return v === null ? null : v.trim();
  };

  // ---- ë Œë” ----
  const listEl = document.getElementById('list');
  function render() {
    document.getElementById('food').value = state.foodTotal || '';
    document.getElementById('alcohol').value = state.alcoholTotal || '';

    listEl.innerHTML = '';
    state.people.forEach((p, idx) => {
      const card = document.createElement('div');
      card.className = 'card';

      const avatar = document.createElement('div');
      avatar.className = 'pill';
      avatar.textContent = p.name.slice(0,2);
      avatar.style.cursor = 'pointer';
      avatar.title = 'ì‚­ì œ';
      avatar.addEventListener('click', () => {
        if (confirm(`ì‚­ì œí• ê¹Œìš”? ${p.name}`)) {
          state.people.splice(idx,1);
          save(); render();
        }
      });

      const nameSeat = document.createElement('div');
      nameSeat.className = 'nameSeat';
      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = p.name;
      name.style.cursor='pointer';
      name.addEventListener('click', () => {
        const v = promptEdit('ì´ë¦„ ìˆ˜ì •', p.name);
        if (v !== null) { p.name = v || p.name; save(); render(); }
      });

      const seat = document.createElement('div');
      seat.className = 'seat';
      seat.textContent = p.seat ? `ì¢Œì„: ${p.seat}` : 'ì¢Œì„ ë¯¸ì§€ì •';
      seat.style.cursor='pointer';
      seat.addEventListener('click', () => {
        const v = promptEdit('ì¢Œì„(ë¹ˆì¹¸=ë¯¸ì§€ì •)', p.seat || '');
        if (v !== null) { p.seat = v || ''; save(); render(); }
      });

      nameSeat.appendChild(name);
      nameSeat.appendChild(seat);

      const minus = document.createElement('button');
      minus.textContent = 'âˆ’';
      minus.className = 'pill';
      minus.addEventListener('click', () => {
        p.shots = Math.max(0, (p.shots||0) - 1); save(); render();
      });

      const shots = document.createElement('div');
      shots.className = 'shots';
      shots.textContent = `${p.shots||0}ì”`;
      shots.style.userSelect='none';
      shots.style.cursor='pointer';
      // íƒ­=+1, ê¸¸ê²Œ=âˆ’1
      let pressTimer;
      let longPress = false;
      
      shots.addEventListener('touchstart', e => {
        longPress = false;
        pressTimer = setTimeout(() => {
          longPress = true;
          minus.click();
          // ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ì´ë¯¸ ì²˜ë¦¬í–ˆìœ¼ë‹ˆ íƒ€ì´ë¨¸ ë¹„ì›€
          pressTimer = null;
        }, 500);
      }, {passive:true});
      
      shots.addEventListener('touchend', e => {
        if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
        if (!longPress) { // ê¸¸ê²Œ ëˆ„ë¥¸ ê²Œ ì•„ë‹ˆë©´ +1
          p.shots = (p.shots||0) + 1;
          save(); render();
        }
      });
      
      shots.addEventListener('click', () => { p.shots=(p.shots||0)+1; save(); render(); });

      const plus = document.createElement('button');
      plus.textContent = '+';
      plus.className = 'pill';
      plus.addEventListener('click', () => {
        p.shots = (p.shots||0) + 1; save(); render();
      });

      card.appendChild(avatar);
      card.appendChild(nameSeat);
      card.appendChild(minus);
      card.appendChild(shots);
      card.appendChild(plus);
      listEl.appendChild(card);
    });
  }

  // ---- ì •ì‚° ----
  function settle() {
    const n = state.people.length || 1;
    const foodPer = (Number(state.foodTotal)||0) / n;
    const totalShots = state.people.reduce((a,b)=>a+(b.shots||0),0);
    let lines = [];
    lines.push(`ğŸ² ìŒì‹: â‚©${money(state.foodTotal)} ê· ë“± / ğŸ¶ ìˆ : â‚©${money(state.alcoholTotal)} ì”ìˆ˜ë¹„ë¡€`);
    lines.push('â€” â€” â€”');
    state.people.forEach(p => {
      const alcShare = totalShots>0 ? ((p.shots||0)/totalShots) * (Number(state.alcoholTotal)||0) : 0;
      const pay = foodPer + alcShare;
      lines.push(`${p.name}  ${p.seat?`(${p.seat}) `:''}â†’ â‚©${money(pay)}  [${p.shots||0}ì”]`);
    });
    const text = lines.join('\n');

    // ëª¨ë‹¬ ëŒ€ì‹  ê°„ë‹¨ ì•Œë¦¼ + ê³µìœ 
    if (navigator.share) {
      navigator.share({ text, title: 'ì •ì‚° ê²°ê³¼' }).catch(()=>alert(text));
    } else {
      alert(text);
    }
  }

  // ---- ì´ë²¤íŠ¸ ë°”ì¸ë”© ----
  document.getElementById('add').addEventListener('click', () => {
    const name = (document.getElementById('newName').value || '').trim();
    const seat = (document.getElementById('newSeat').value || '').trim();
    state.counter = (state.counter||0) + 1;
    state.people.push({
      id: crypto.randomUUID(),
      name: name || `ì†ë‹˜ ${state.counter}`,
      seat: seat || '',
      shots: 0
    });
    document.getElementById('newName').value='';
    document.getElementById('newSeat').value='';
    save(); render();
  });

  document.getElementById('food').addEventListener('input', e => {
    state.foodTotal = Number(e.target.value||0); save();
  });
  document.getElementById('alcohol').addEventListener('input', e => {
    state.alcoholTotal = Number(e.target.value||0); save();
  });

  document.getElementById('settle').addEventListener('click', settle);

  document.getElementById('reset').addEventListener('click', () => {
    if (!confirm('ëª¨ë“  ì”ìˆ˜ì™€ ê¸ˆì•¡ì„ 0ìœ¼ë¡œ ë¦¬ì…‹í• ê¹Œìš”?')) return;
    state.people.forEach(p => p.shots=0);
    state.foodTotal = 0; state.alcoholTotal = 0;
    save(); render();
  });

  // ì •ì‚°í‘œ í…ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜(settle()ì™€ ë™ì¼ í¬ë§· ì¬ì‚¬ìš©)
function buildSettlementText() {
  const n = state.people.length || 1;
  const foodPer = (Number(state.foodTotal)||0) / n;
  const totalShots = state.people.reduce((a,b)=>a+(b.shots||0),0);

  let lines = [];
  lines.push(`ğŸ² ìŒì‹: â‚©${money(state.foodTotal)} ê· ë“± / ğŸ¶ ìˆ : â‚©${money(state.alcoholTotal)} ì”ìˆ˜ë¹„ë¡€`);
  lines.push('â€” â€” â€”');
  state.people.forEach(p => {
    const alcShare = totalShots>0 ? ((p.shots||0)/totalShots) * (Number(state.alcoholTotal)||0) : 0;
    const pay = foodPer + alcShare;
    lines.push(`${p.name}  ${p.seat?`(${p.seat}) `:''}â†’ â‚©${money(pay)}  [${p.shots||0}ì”]`);
  });
  return lines.join('\n');
}

// JSON ë°±ì—…(ê°€ì ¸ì˜¤ê¸°ë¥¼ ìœ„í•´ ìœ ì§€, ê¸¸ê²Œëˆ„ë¥´ê¸°ìš©)
function downloadJsonBackup() {
  const payload = JSON.stringify(state, null, 2);
  const blob = new Blob([payload], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'drink-counter.json'});
  a.click(); URL.revokeObjectURL(url);
}

(() => {
  const btn = document.getElementById('exportBtn');
  let timer = null, longPressed = false;

  // í„°ì¹˜: ê¸¸ê²Œ ëˆ„ë¥´ë©´ JSON ë°±ì—…, ë–¼ë©´(ê¸¸ê²Œ ì•„ë‹˜) í…ìŠ¤íŠ¸ ê³µìœ 
  btn.addEventListener('touchstart', () => {
    longPressed = false;
    timer = setTimeout(() => { longPressed = true; downloadJsonBackup(); }, 600);
  }, {passive:true});

  btn.addEventListener('touchend', () => {
    if (timer) clearTimeout(timer);
    if (!longPressed) {
      const text = buildSettlementText();
      if (navigator.share) navigator.share({title:'ì •ì‚°í‘œ', text}).catch(()=>alert(text));
      else alert(text);
    }
  });

  // ë§ˆìš°ìŠ¤(PC): ìš°í´ë¦­=ë°±ì—…, ì¢Œí´ë¦­=ì •ì‚°í‘œ ê³µìœ /í‘œì‹œ
  btn.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    downloadJsonBackup();
  });
  btn.addEventListener('click', () => {
    const text = buildSettlementText();
    if (navigator.share) navigator.share({title:'ì •ì‚°í‘œ', text}).catch(()=>alert(text));
    else alert(text);
  });
})();


  // ---- PWA ë“±ë¡ ----
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  // ì´ˆê¸°í™”
  load(); render();
</script>
</body>
</html>
